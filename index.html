<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¨ãƒƒã‚¸ãƒãƒ¼ã‚«ãƒ¼ãƒ»ãƒ—ãƒ­ã‚¿ã‚¤ãƒãƒ¼</title>
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22ã‚¹ã‚¿ãƒŸãƒŠé€šçŸ¥PRO%22,%22short_name%22:%22é€šçŸ¥PRO%22,%22display%22:%22standalone%22,%22start_url%22:%22index.html%22,%22background_color%22:%22#0f172a%22,%22theme_color%22:%22#3b82f6%22}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    
    <style>
        .heart { font-size: 2.5rem; transition: all 0.3s; position: relative; display: inline-block; }
        .heart-empty { color: #334155; }
        .heart-filled { color: #ef4444; position: absolute; top: 0; left: 0; overflow: hidden; width: 0%; }
        input[type=range]::-webkit-slider-thumb { border-radius: 50%; width: 24px; height: 24px; background: #ef4444; appearance: none; border: 3px solid white; }
    </style>

    <script>
        // ã‚¹ãƒªãƒ¼ãƒ—ä¸­ã‚‚é€šçŸ¥ã‚’é€ã‚‹ãŸã‚ã®ä»•æ›ã‘
        if ('serviceWorker' in navigator) {
            const code = "self.addEventListener('install', e => self.skipWaiting()); self.addEventListener('notificationclick', e => { e.notification.close(); clients.openWindow('/'); });";
            const blob = new Blob([code], {type: 'application/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }
    </script>
</head>
<body class="bg-slate-900 text-white p-5 select-none">

    <div class="max-w-md mx-auto bg-slate-800 rounded-[2.5rem] p-8 border border-slate-700 shadow-2xl mt-4">
        <h1 class="text-xl font-bold text-center mb-6 text-blue-400">ã‚¹ã‚¿ãƒŸãƒŠé€šçŸ¥ PRO</h1>

        <div class="flex justify-between mb-8 px-2">
            <div class="heart"><span class="heart-empty">â™¥</span><span class="heart-filled" id="f1">â™¥</span></div>
            <div class="heart"><span class="heart-empty">â™¥</span><span class="heart-filled" id="f2">â™¥</span></div>
            <div class="heart"><span class="heart-empty">â™¥</span><span class="heart-filled" id="f3">â™¥</span></div>
            <div class="heart"><span class="heart-empty">â™¥</span><span class="heart-filled" id="f4">â™¥</span></div>
            <div class="heart"><span class="heart-empty">â™¥</span><span class="heart-filled" id="f5">â™¥</span></div>
        </div>

        <div class="bg-slate-900/50 p-6 rounded-2xl mb-6 text-center">
            <input type="range" id="staminaSlider" min="0" max="20" value="0" step="1" 
                   class="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                   oninput="updateUI(this.value)">
            <p id="statusLabel" class="mt-4 font-bold text-red-400 text-xl tracking-tighter">ç¾åœ¨: 0.00 å€‹</p>
        </div>

        <button onclick="startTimer()" class="w-full bg-blue-600 active:bg-blue-700 py-5 rounded-2xl font-black text-xl shadow-lg mb-8 transition-all transform active:scale-95">
            é€šçŸ¥ã‚’äºˆç´„ã™ã‚‹
        </button>

        <details class="bg-slate-900/80 rounded-2xl p-4">
            <summary class="cursor-pointer text-center text-slate-500 text-xs font-bold">ğŸ“¸ ã‚¹ã‚¯ã‚·ãƒ§ã§æ™‚é–“ã‚’è£œæ­£</summary>
            <div class="mt-4 space-y-4 text-center">
                <input type="file" id="upload" accept="image/*" class="text-xs text-slate-400 mx-auto w-full">
                <div id="ocrStatus" class="text-blue-400 text-[10px] h-4"></div>
                <div class="flex items-center justify-center gap-3">
                    <span class="text-xs text-slate-400">æ¬¡ã¾ã§</span>
                    <input type="number" id="manualMin" value="60" class="w-16 bg-slate-700 p-2 rounded-xl text-white text-center font-bold text-lg">
                    <span class="text-xs text-slate-400">åˆ†</span>
                </div>
            </div>
        </details>

        <div id="schedule" class="mt-8 space-y-3 text-sm text-slate-400 border-t border-slate-700 pt-6"></div>
    </div>

    <script>
        const MIN_PER_STEP = 60;

        function updateUI(val) {
            for (let i = 1; i <= 5; i++) {
                const filled = document.getElementById(`f${i}`);
                const heartLevel = Math.max(0, Math.min(4, val - (i - 1) * 4));
                filled.style.width = (heartLevel * 25) + "%";
            }
            document.getElementById('statusLabel').innerText = `ç¾åœ¨: ${(val / 4).toFixed(2)} å€‹`;
        }

        document.getElementById('upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const status = document.getElementById('ocrStatus');
            status.innerText = "è§£æä¸­...";
            try {
                const worker = await Tesseract.createWorker('eng');
                await worker.setParameters({ tessedit_char_whitelist: '0123456789:' });
                const { data: { text } } = await worker.recognize(file);
                const timeMatch = text.match(/(\d{1,2}):\d{2}/);
                if (timeMatch) {
                    const mins = parseInt(timeMatch[1]);
                    document.getElementById('manualMin').value = mins + 1;
                    status.innerText = `èª­ã¿å–ã‚ŠæˆåŠŸ: æ®‹ã‚Š ${mins} åˆ†`;
                } else {
                    status.innerText = "èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ";
                }
                await worker.terminate();
            } catch (err) { status.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"; }
        });

        async function startTimer() {
            const currentSteps = parseInt(document.getElementById('staminaSlider').value);
            const permission = await Notification.requestPermission();
            
            if (permission !== "granted") {
                alert("iPhoneã®è¨­å®šã‹ã‚‰é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚ä¸€åº¦ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
                return;
            }

            const scheduleDiv = document.getElementById('schedule');
            scheduleDiv.innerHTML = "";
            const firstWait = parseInt(document.getElementById('manualMin').value) || MIN_PER_STEP;
            const targets = [4, 12, 20];

            targets.forEach(target => {
                if (target > currentSteps) {
                    const diffSteps = target - currentSteps;
                    const waitMin = firstWait + ((diffSteps - 1) * MIN_PER_STEP);
                    const time = new Date(Date.now() + waitMin * 60000);
                    const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    let msg = `ãƒãƒ¼ãƒˆãŒ ${target/4} å€‹ã«ãªã‚Šã¾ã—ãŸï¼`;
                    if (target === 20) msg = "å…¨å›å¾©(MAX)ã—ã¾ã—ãŸï¼";

                    // é€šçŸ¥ã‚’äºˆç´„
                    setTimeout(() => {
                        new Notification("ã‚¨ãƒƒã‚¸ãƒãƒ¼ã‚«ãƒ¼", { body: msg, icon: "https://cdn-icons-png.flaticon.com/512/833/833472.png" });
                    }, waitMin * 60000);

                    scheduleDiv.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-900/30 p-3 rounded-xl border border-slate-700/50">
                            <span class="font-bold text-slate-300">${target/4}å€‹ç›®</span>
                            <span class="text-blue-400 font-mono text-lg">${timeStr}</span>
                        </div>`;
                }
            });
            alert("äºˆç´„å®Œäº†ï¼ç”»é¢ã‚’é–‰ã˜ã¦ã‚‚(ã‚¹ãƒªãƒ¼ãƒ—ã—ã¦ã‚‚)é€šçŸ¥ãŒå±Šãã¾ã™ã€‚");
        }
    </script>
</body>
</html>